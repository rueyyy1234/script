clear

data_ori = [1, 1, 0, 1, 1, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 0, 0, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 0, 1, 0, 1, 0, 0, 0, 0, 1, 1, 0, 1, 0, 0, 0, 1, 1, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 0, 0, 1, 0, 1, 0, 1, 0, 1, 1, 1, 1, 1, 0, 0, 0, 1, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 1, 1, 1, 1, 0, 1, 1, 0, 1, 0, 0, 1, 1, 1, 0, 1, 0, 0, 0, 0, 1, 0, 1, 0, 1, 0, 1, 1, 1, 0, 0, 0, 1, 0, 1, 1, 1, 0, 0, 0, 1, 0, 1, 1, 1, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 0, 0, 0, 1, 1, 1, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 0, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 1, 0, 0, 0, 0, 1, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 1, 1, 0, 1, 0, 0, 1, 1, 1, 0, 0, 1, 1, 0, 0, 1, 0, 1, 1, 1, 0, 0, 0, 1, 0, 1, 0, 1, 0, 1, 1, 1, 1, 0, 1, 0, 0, 1, 1, 0, 1, 1, 1, 1, 1, 1, 0, 0, 1, 0, 0, 0, 1, 1, 1, 0, 0, 1, 0, 0, 1, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1, 0, 0, 0, 0, 1, 1, 0, 0, 1, 0, 1, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 1, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1, 0, 0, 1, 1, 1, 0, 0, 0, 1, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 1, 1, 1, 0, 1, 0, 1, 1, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 1, 1, 0, 0, 0, 1, 1, 0, 1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 0, 1, 1, 1, 1, 1, 0, 1, 0, 1, 1, 0, 0, 0, 1, 1, 0, 1, 1, 0, 1, 0, 1, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 1, 0, 1, 0, 1, 0, 0, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 0, 1, 0, 0, 1, 0, 0, 1, 1, 0, 1, 0, 1, 1, 0, 1, 1, 1, 1, 0, 0, 0, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 1, 0, 1, 1, 1, 0, 0, 1, 1, 1, 0, 0, 1, 0, 0, 1, 0, 0, 1, 0, 1, 0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 1, 0, 1, 1, 0, 0, 1, 1, 0, 1, 0, 1, 1, 0, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 0, 1, 0, 0, 1, 1, 1, 1, 1, 0, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 0, 1, 0, 1, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 1, 0, 1, 0, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1, 0, 0, 0, 0, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 1, 1, 1, 0, 0, 0, 0, 1, 0, 1, 0, 1, 1, 1, 1, 0, 0, 0, 1, 1, 0, 0, 0, 0, 1, 0, 0, 0, 1, 1, 0, 1, 0, 1, 1, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 1, 1, 0, 1, 0, 0, 1, 0, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 0, 0, 1, 0, 1, 1, 0, 0, 1, 0, 1, 1, 1, 0, 0, 0, 1, 1, 1, 0, 1, 0, 0, 1, 0, 1, 1, 1, 1, 0, 1, 1, 1, 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 0, 0, 1, 0, 1, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 1, 1, 0, 1, 1, 0, 1, 0, 1, 0, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 1, 0, 1, 0, 1, 0, 0, 0, 1, 1, 0, 1, 0, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 1, 1, 1, 0, 1, 0, 0, 0, 1, 0, 0, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 0, 1, 0, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 0, 1, 1, 1, 1, 0, 0, 1, 0, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 1, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 1, 1, 1, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 1, 0, 1, 0, 1, 0, 1, 1, 1, 1, 0, 1, 1, 1, 0, 0, 0, 0, 1, 1, 0, 1, 0, 1, 1, 0, 1, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 1, 0, 1, 0, 0, 1, 1, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 0, 1, 0, 1, 0, 0, 0, 0, 0, 1, 1, 1, 0, 1, 1, 1, 0, 0, 1, 1, 0, 0, 1, 0, 1, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 1, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 1, 0, 1, 1, 0, 1, 0, 0, 1, 1, 1, 1, 0, 1, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 0, 1, 0, 1, 0, 0, 1, 1, 0, 1, 1, 1, 0, 0, 1, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 0, 1, 0, 1, 0, 1, 0, 1, 1, 0, 1, 0, 0, 1, 0, 1, 0, 1, 1, 1, 0, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 0, 1, 1, 0, 1, 1, 1, 1, 0, 0, 1, 0, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 0, 0, 1, 0, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1, 1, 0, 1, 0, 0, 1, 1, 1, 0, 1, 0, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 1, 0, 1, 0, 0, 1, 1, 1, 0, 1, 1, 0, 0, 0, 1, 0, 1, 1, 0, 0, 1, 1, 1, 1, 0, 0, 1, 1, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 1, 1, 0, 0, 1, 1, 1, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 0, 0, 1, 0, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 1, 1, 1, 0, 1, 1, 0, 1, 1, 0, 1, 1, 0, 0, 0, 1, 1, 0, 1, 1, 1, 1, 0, 0, 1, 0, 0, 0, 1, 0, 1, 0, 1, 1, 0, 1, 0, 1, 1, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 1, 0, 1, 0, 1, 0, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 0, 1, 1, 0, 1, 1, 0, 1, 1, 0, 1, 1, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0];
SENT_BIT_LEN = 1500;
SAMP_RATE = 0.5e6;
plot_raw_signal = 1;
% plot_filtered_signal = 1;
% plot_filtered_signal_env = 1;
% plot_sampled_data = 1;
plot_data = 1;
% find_start_index = 1;
set_x_lim = [35600 37000];
set_y_lim = [0 5];
set_time = 1;
idx = 16;


params = getParams(idx);
raw_data = getRawData(params.bps,params.distance,params.medium,SAMP_RATE);
V_in = raw_data(:, 1);
V_out = raw_data(:, 2);
t_V = (0:(length(V_in)-1)).*(1/SAMP_RATE).*1000;

samples_per_bit = SAMP_RATE / params.bps;

f1 = 42.5e3;
f2 = 85e3;
filter_samp_no = 200;
filt_threshold = 5e3;
filter_f1 = [f1 - filt_threshold, f1 + filt_threshold];
filter_f2 = [f2 - filt_threshold, f2 + filt_threshold];

Tx_data_low = bandpass(V_in, filter_f1, SAMP_RATE,ImpulseResponse="iir");
Tx_data_low_env = abs(envelope(Tx_data_low, filter_samp_no, "analytic"));
Tx_data_high = bandpass(V_in, filter_f2, SAMP_RATE,ImpulseResponse="iir");
Tx_data_high_env = abs(envelope(Tx_data_high, filter_samp_no, "analytic"));
Tx_data = (Tx_data_high_env > Tx_data_low_env)';

if exist('find_start_index','var')
    find(Tx_data==1,1)
    return
end

Rx_data_low = bandpass(V_out, filter_f1, SAMP_RATE,ImpulseResponse="iir");
Rx_data_low_env = abs(envelope(Rx_data_low, filter_samp_no, "analytic"));
Rx_data_high = bandpass(V_out, filter_f2, SAMP_RATE,ImpulseResponse="iir");
Rx_data_high_env = abs(envelope(Rx_data_high, filter_samp_no, "analytic"));
Rx_data = (Rx_data_high_env > Rx_data_low_env)';

Tx_data_in = samplesToData(Tx_data, samples_per_bit, SENT_BIT_LEN);
if(sum(abs(Tx_data_in-data_ori)) > 0)
    error("Tx data demodulation failed!")
end
Rx_data_in = samplesToData(Rx_data, samples_per_bit, SENT_BIT_LEN);
t_data = (0:length(Tx_data) - 1) .* (1 / SAMP_RATE);

t_tx_data = (0:length(Tx_data) - 1) .* (1 / SAMP_RATE) .* 1000;
t_rx_data = (0:length(Rx_data) - 1) .* (1 / SAMP_RATE) .* 1000;

ber = sum(abs(Tx_data_in - Rx_data_in)) / length(Tx_data_in);
fprintf("(%d)...%d bps, %d mm, %s, BER = %.5f\n",...
    idx, params.bps, params.distance, params.medium, ber)

if (ber > 0)
    err_idx(1,:) = find(abs(Tx_data_in - Rx_data_in) == 1);
    err_idx(2,:) = find(abs(Tx_data_in - Rx_data_in) == 1).*samples_per_bit;
end


if exist('plot_raw_signal','var')
    figure
    tl = tiledlayout('vertical');
    title_str = sprintf("%d bps, %d mm, %s",params.bps,params.distance,params.medium);
    title(tl, title_str)

    nexttile
    if exist('set_time','var')
        plot(t_V,V_in, "LineWidth", 2)
    else
        plot(V_in, "LineWidth", 2)
    end
    title('V_{in}')
    if exist('set_x_lim','var')
        xlim(set_x_lim)
        if exist('set_time','var')
            xlim(set_x_lim.*(1/SAMP_RATE).*1000)
        end
    end
    if exist('set_y_lim','var')
        ylim([-set_y_lim(2) set_y_lim(2)])
    end

    nexttile
    if exist('set_time','var')
        plot(t_V,V_out, "LineWidth", 2)
    else
        plot(V_out, "LineWidth", 2)
    end
    title('V_{out}')
    if exist('set_x_lim','var')
        xlim(set_x_lim)
        if exist('set_time','var')
            xlim(set_x_lim.*(1/SAMP_RATE).*1000)
        end
    end
    if exist('set_y_lim','var')
        ylim([-set_y_lim(2) set_y_lim(2)])
    end

end

if exist('plot_filtered_signal','var')
    figure
    tl = tiledlayout('vertical');
    title_str = sprintf("%d bps, %d mm, %s",params.bps,params.distance,params.medium);
    title(tl, title_str)

    nexttile

    if exist('set_time','var')
        plot(t_tx_data,Tx_data_low, "LineWidth", 2)
        hold on
        plot(t_tx_data,Tx_data_high, "LineWidth", 2)
        hold off
    else
        plot(Tx_data_low, "LineWidth", 2)
        hold on
        plot(Tx_data_high, "LineWidth", 2)
        hold off
    end
    title('Tx Data')
    legend(["f_1", "f_2"])
    if exist('set_x_lim','var')
        xlim(set_x_lim)
    end
    if exist('set_y_lim','var')
        ylim([-set_y_lim(2) set_y_lim(2)])
    end

    nexttile
    if exist('set_time','var')
        plot(t_rx_data,Rx_data_low, "LineWidth", 2)
        hold on
        plot(t_rx_data,Rx_data_high, "LineWidth", 2)
        hold off
    else
        plot(Rx_data_low, "LineWidth", 2)
        hold on
        plot(Rx_data_high, "LineWidth", 2)
        hold off
    end
    title('Rx Data')
    legend(["f_1", "f_2"])
    if exist('set_x_lim','var')
        xlim(set_x_lim)
    end
    if exist('set_y_lim','var')
        ylim([-set_y_lim(2) set_y_lim(2)])
    end
end

if exist('plot_filtered_signal_env','var')
    figure
    tl = tiledlayout('vertical');
    title_str = sprintf("%d bps, %d mm, %s",params.bps,params.distance,params.medium);
    title(tl, title_str)

    nexttile
    plot(Tx_data_low_env, "LineWidth", 2)
    hold on
    plot(Tx_data_high_env, "LineWidth", 2)
    hold off
    title('Tx Data')
    legend(["f_1", "f_2"])
    if exist('set_x_lim','var')
        xlim(set_x_lim)
    end
    if exist('set_y_lim','var')
        ylim(set_y_lim)
    end

    nexttile
    plot(Rx_data_low_env, "LineWidth", 2)
    hold on
    plot(Rx_data_high_env, "LineWidth", 2)
    hold off
    title('Rx Data')
    legend(["f_1", "f_2"])
    if exist('set_x_lim','var')
        xlim(set_x_lim)
    end
    if exist('set_y_lim','var')
        ylim(set_y_lim)
    end
end

if exist('plot_sampled_data','var')
    figure
    tl = tiledlayout('vertical');
    title_str = sprintf("%d bps, %d mm, %s",params.bps,params.distance,params.medium);
    title(tl, title_str)
    nexttile
    if exist('set_time','var')
        stairs(t_tx_data,Tx_data,"LineWidth",2.5)
    else
        stairs(Tx_data, "LineWidth", 2.5)
    end

    ylim([-0.1 1.1])
    set(gca, 'Fontsize', 20)
    yticks([0 1])
    title("送信データ")
    if exist('set_x_lim','var')
        xlim(set_x_lim)
        if exist('set_time','var')
            xlim((set_x_lim.* (1 / SAMP_RATE) .* 1000))
        end
    end

    nexttile
    if exist('set_time','var')
        stairs(t_rx_data,Rx_data,"LineWidth",2.5)
    else
        stairs(Rx_data, "LineWidth", 2.5)
    end
    ylim([-0.1 1.1])
    set(gca, 'Fontsize', 20)
    title("受信データ")
    yticks([0 1])
    if exist('set_x_lim','var')
        xlim(set_x_lim)
        if exist('set_time','var')
            xlim((set_x_lim.* (1 / SAMP_RATE) .* 1000))
        end
    end
end

if exist('plot_data','var')
    figure
    tl = tiledlayout('vertical');
    title_str = sprintf("%d bps, %d mm, %s",params.bps,params.distance,params.medium);
    title(tl, title_str)
    nexttile
    if exist('set_time','var')
        t_tx_data_in = (0:length(Tx_data_in)-1).*(1/params.bps).*1000;
        stairs(t_tx_data_in,Tx_data_in,"LineWidth",2.5)
    else
        stairs(Tx_data_in, "LineWidth", 2.5)
    end

    ylim([-0.1 1.1])
    set(gca, 'Fontsize', 20)
    yticks([0 1])
    title("送信データ")
    if exist('set_x_lim','var')
        xlim(set_x_lim./samples_per_bit)
        if exist('set_time','var')
            xlim((set_x_lim./(samples_per_bit.*params.bps).*1000))
        end
    end

    nexttile
    if exist('set_time','var')
        t_rx_data_in = (0:length(Rx_data_in)-1).*(1/params.bps).*1000;
        stairs(t_rx_data_in,Rx_data_in,"LineWidth",2.5)
    else
        stairs(Rx_data_in, "LineWidth", 2.5)
    end
    ylim([-0.1 1.1])
    set(gca, 'Fontsize', 20)
    title("受信データ")
    yticks([0 1])
    if exist('set_x_lim','var')
        xlim(set_x_lim.*(1/samples_per_bit))
        if exist('set_time','var')
            xlim((set_x_lim./(samples_per_bit.*params.bps).*1000))
        end
    end
end